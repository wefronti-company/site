name: Deploy to Vercel

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Job 1: Lint and Type Check
  quality-checks:
    name: 'Step 1: Quality Checks'
    runs-on: ubuntu-latest
    
    steps:
      - name: 1.1 - Checkout code
        uses: actions/checkout@v4
        
      - name: 1.2 - Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 1.3 - Install dependencies
        run: npm ci
        
      - name: 1.4 - Run TypeScript type check
        run: npx tsc --noEmit
        
      - name: 1.5 - Check code formatting
        run: npx prettier --check "**/*.{ts,tsx,js,jsx,json,css,md}"
        continue-on-error: true

  # Job 2: Build Test
  build-test:
    name: 'Step 2: Build Verification'
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
      - name: 2.1 - Checkout code
        uses: actions/checkout@v4
        
      - name: 2.2 - Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 2.3 - Install dependencies
        run: npm ci
        
      - name: 2.4 - Build application
        run: npm run build
        
      - name: 2.5 - Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 1

  # Job 3: Deploy Preview (Pull Requests)
  deploy-preview:
    name: 'Step 3: Deploy Preview'
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: 3.1 - Checkout code
        uses: actions/checkout@v4
        
      - name: 3.2 - Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 3.3 - Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: 3.4 - Pull Vercel environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: 3.5 - Build project artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: 3.6 - Deploy to Vercel Preview
        id: deploy-preview
        run: |
          url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          
      - name: 3.7 - Comment PR with preview URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview deployment ready!\n\nâœ… Preview URL: ${{ steps.deploy-preview.outputs.url }}\n\n_Deployed from commit ${{ github.sha }}_`
            })

  # Job 4: Deploy Production (Main Branch)
  deploy-production:
    name: 'Step 4: Deploy Production'
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://wefronti.com
    
    steps:
      - name: 4.1 - Checkout code
        uses: actions/checkout@v4
        
      - name: 4.2 - Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 4.3 - Install Vercel CLI
        run: npm install --global vercel@latest
        
      - name: 4.4 - Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: 4.5 - Build project artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        
      - name: 4.6 - Deploy to Vercel Production
        id: deploy-production
        run: |
          set -euo pipefail
          echo "Verifying Vercel CLI version"
          vercel --version || true

          echo "Starting Vercel production deploy (prebuilt)..."
          # Capture full output to a file and preserve exit code
          outfile=vercel_deploy_output.txt
          if ! vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | tee "$outfile"; then
            echo "âš ï¸ Vercel deploy command returned a non-zero exit code"
            # Try to extract Inspect URL to fetch more details
            inspect=$(grep -Eo "https://vercel.com/[^"]+" "$outfile" | head -n 1 || true)
            prod=$(grep -Eo "https?://[a-z0-9-]+\.vercel\.app" "$outfile" | head -n 1 || true)
            echo "--- Vercel deploy output ---"
            tail -n 200 "$outfile" || true
            if [ -n "$inspect" ]; then
              echo "Found inspect URL: $inspect"
              echo "Attempting to run 'vercel inspect' to fetch build logs..."
              # vercel inspect accepts the inspect URL or the deployment id
              vercel inspect "$inspect" --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | sed -n '1,200p' || true
            fi
            if [ -n "$prod" ]; then
              echo "Found production URL: $prod"
              echo "Fetching recent logs for the production deployment (may require token access)"
              vercel logs "$prod" --token=${{ secrets.VERCEL_TOKEN }} --since 10m --limit 200 2>&1 | sed -n '1,500p' || true
            fi
            echo "Failing job due to deployment error"
            exit 1
          fi

          # If successful extract URL and export to GitHub Actions output
          url=$(grep -Eo "https?://[a-z0-9-]+\.vercel\.app" "$outfile" | head -n 1 || true)
          if [ -z "$url" ]; then
            # fallback: try to extract any URL
            url=$(grep -Eo "https://vercel.com/[^"]+" "$outfile" | head -n 1 || true)
          fi
          echo "Deployment completed. URL: $url"
          echo "url=$url" >> $GITHUB_OUTPUT
          
      - name: 4.7 - Create deployment summary
        run: |
          echo "## ðŸš€ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Production URL:** ${{ steps.deploy-production.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **Deployment time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
      - name: 4.8 - Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Production deployment completed successfully!"
          else
            echo "âŒ Production deployment failed!"
            exit 1
          fi

  # Job 5: Post-Deployment Verification
  post-deployment:
    name: 'Step 5: Post-Deployment Checks'
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: 5.1 - Wait for deployment propagation
        run: sleep 10
        
      - name: 5.2 - Check production endpoint
        run: |
          # Retry a few times to allow propagation (useful for DNS/caching)
          # Accept HTTP 200 (OK) or HTTP 401 (site protected / requires auth)
          for attempt in 1 2 3 4 5; do
            response=$(curl -L -s -o /dev/null -w "%{http_code}" https://wefronti.com)
            if [ "$response" -eq 200 ] || [ "$response" -eq 401 ]; then
              if [ "$response" -eq 401 ]; then
                echo "âš ï¸ Production site returned HTTP 401 (authentication required) â€” treating as successful protected deployment"
              else
                echo "âœ… Production site is responding (HTTP $response)"
              fi
              success=true
              break
            fi
            echo "Attempt $attempt: received HTTP $response; retrying in 5s..."
            sleep 5
          done
          if [ "$success" != "true" ]; then
            echo "âš ï¸ Production site returned HTTP $response"
            exit 1
          fi
          
      - name: 5.3 - Verify deployment completion
        run: |
          echo "## ðŸŽ‰ Deployment Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quality checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build verification" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production deployment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live at:** https://wefronti.com" >> $GITHUB_STEP_SUMMARY
